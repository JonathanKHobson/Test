<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Persona Builder — ESCO Test</title>
<style>
  :root{ --bg:#0b0f14; --card:#0f151d; --text:#e7eff7; --muted:#9db0c3; --accent:#4ea1ff; --border:#1b2838; --radius:12px; }
  body{ margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background:var(--bg); color:var(--text); }
  header{ display:flex; gap:12px; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border); position:sticky; top:0; background:linear-gradient(#0b0f1488,#0b0f14 60%); backdrop-filter:saturate(1.2) blur(6px);}
  input[type="text"]{ flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0c121a; color:var(--text); }
  button{ cursor:pointer; border:1px solid var(--border); background:#13202e; color:var(--text); padding:10px 12px; border-radius:10px; }
  button.primary{ background:var(--accent); color:#061422; border:none; }
  main{ display:grid; grid-template-columns: 360px 1fr; gap:16px; padding:16px; }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:12px; }
  .results{ max-height:60vh; overflow:auto; display:flex; flex-direction:column; gap:8px; }
  .result{ border:1px solid var(--border); border-radius:10px; padding:10px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .result small{ color:var(--muted); display:block; margin-top:2px; }
  .result .pick{ white-space:nowrap; }
  .pill{ font-size:12px; color:var(--muted); border:1px solid var(--border); padding:2px 6px; border-radius:999px; }
  .stack{ display:flex; flex-direction:column; gap:10px; }
  .row{ display:flex; gap:8px; align-items:center; }
  pre{ white-space:pre-wrap; word-break:break-word; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#0b1119; padding:10px; border-radius:10px; border:1px solid var(--border); }
  .muted{ color:var(--muted); }
</style>
</head>
<body>
  <header>
    <strong>Persona Builder — ESCO Probe</strong>
    <input id="q" type="text" placeholder="Try: ux, researcher, nurse, developer…" />
    <button id="search">Search</button>
    <button id="export" class="primary" disabled>Export as JS</button>
    <label style="font-size:12px;">
  <input type="checkbox" id="toggle-proxy">
  Use dev CORS proxy (only if needed)
</label>
  </header>

  <main>
    <section class="card stack">
      <div class="row"><span class="pill">Results</span><span id="count" class="muted"></span></div>
      <div id="results" class="results" role="listbox" aria-label="Search results"></div>
    </section>

    <section class="card stack">
      <div class="row"><span class="pill">Preview (normalized personas)</span><span id="selCount" class="muted"></span></div>
      <pre id="out" aria-live="polite">{ "personas": [] }</pre>
    </section>
  </main>

<script>


// DEV: CORS helper (toggle via checkbox); warns if page is opened via file://
let USE_PROXY = false;
function maybeProxy(url) {
  return USE_PROXY ? `https://cors.isomorphic-git.org/${url}` : url;
}
window.addEventListener("DOMContentLoaded", () => {
  if (location.protocol === "file:") {
    const warn = document.createElement("div");
    warn.textContent = "Heads up: running from file:// often breaks public APIs due to CORS. Start a local server (e.g., `python -m http.server 8080`) and open http://localhost:8080/test-persona.html";
    warn.style.cssText = "background:#fff3cd;color:#664d03;padding:8px;border:1px solid #ffecb5;margin-bottom:8px;border-radius:6px;font:12px/1.4 system-ui";
    document.body.prepend(warn);
  }
  const proxyToggle = document.getElementById("toggle-proxy");
  if (proxyToggle) proxyToggle.addEventListener("change", (e) => (USE_PROXY = e.target.checked));
});


const ESCO_BASE = "https://ec.europa.eu/esco/api";
const MAX_TASKS = 6;
const MAX_SKILLS = 10;

const el = {
  q: document.getElementById('q'),
  search: document.getElementById('search'),
  exportBtn: document.getElementById('export'),
  results: document.getElementById('results'),
  out: document.getElementById('out'),
  count: document.getElementById('count'),
  selCount: document.getElementById('selCount')
};

let selectedPersonas = []; // normalized persona objects

function slugify(u){ try{ return u.split("/").filter(Boolean).pop(); }catch(e){ return String(u||'').replace(/[^\w-]+/g,'-').toLowerCase(); } }
function dedupe(arr){ return [...new Set((arr||[]).filter(Boolean))]; }
function safeFirstSentences(text, n=2){
  if (!text) return [];
  const m = String(text).match(/[A-Z][^.!?]*[.!?]/g);
  return (m || []).slice(0, n);
}

// ---- Robust string helpers ----
function extractStrings(x){
  const out = [];
  const visit = (v) => {
    if (!v) return;
    if (typeof v === 'string') { out.push(v); return; }
    if (Array.isArray(v)) { v.forEach(visit); return; }
    if (typeof v === 'object') { Object.values(v).forEach(visit); return; }
  };
  visit(x);
  return out;
}
function asText(v){
  if (!v) return '';
  if (typeof v === 'string') return v;
  if (Array.isArray(v)) return (v.map(asText).find(Boolean) || '');
  if (typeof v === 'object'){
    // common language keys first
    for (const k of ['en','en-GB','en-US']) if (typeof v[k] === 'string') return v[k];
    // fallback: first string we can find
    const first = extractStrings(v)[0];
    return first || '';
  }
  return String(v);
}


function defaultToneForOccupation(label){
  const l = String(label||'').toLowerCase();

  if (l.includes("research")) return "Curious, methodical, empathetic";
  if (l.includes("design")) return "Pragmatic, user-centered, collaborative";
  if (l.includes("engineer") || l.includes("developer")) return "Analytical, precise, systems-minded";
  if (l.includes("manager")) return "Outcome-driven, communicative, structured";
  return "Professional, clear, evidence-oriented";
}
function deriveGoalsFromSkills(skills){
  const goals = [];
  for (const s of (skills||[]).slice(0,4)) goals.push(`Improve outcomes using ${s.toLowerCase()}`);
  goals.push("Reduce risk and rework");
  return dedupe(goals);
}
function derivePainsFromSkills(skills){
  const pains = [];
  for (const s of (skills||[]).slice(0,4)) pains.push(`Gaps in ${s.toLowerCase()} across team`);
  pains.push("Time constraints and shifting priorities");
  return dedupe(pains);
}

async function searchOccupations(query, limit = 25) {
   const url = `${ESCO_BASE}/suggest2?text=${encodeURIComponent(query)}&language=en&type=occupation&limit=${limit}`;
  const data = await fetchJSONCORS(url);
  const items = data?._embedded?.results || data?._embedded?.suggestions || data?.results || data?.suggestions || [];
  return items.map((it) => {
    const uri = it.uri || it._links?.self?.href || it._links?.occupation?.href || "";
    const title = it.title || it.prefLabel || it.preferredLabel || it.label || "";
    const broader = it.broaderPreferredLabel || it.broaderPrefLabel || it.occupationGroup || "";
    return uri && title ? { uri, preferredLabel: title, broaderPreferredLabel: broader } : null;
  }).filter(Boolean);


async function searchOccupationsFallback(query, limit = 25) {
  const url = `${ESCO_BASE}/resource/occupation?text=${encodeURIComponent(query)}&language=en&limit=${limit}`;
  const data = await fetchJSONCORS(url);
  const list = data?._embedded?.occupation || [];
  return list.map(o => {
    const uri = o.uri || o._links?.self?.href || "";
    const title = o.preferredLabel || o.title || "";
    const broader = o.broaderPreferredLabel || "";
    return uri && title ? { uri, preferredLabel: title, broaderPreferredLabel: broader } : null;
  }).filter(Boolean);




async function getOccupationByUri(uri) {
    const url = `${ESCO_BASE}/resource/occupation?uri=${encodeURIComponent(uri)}&language=en`;
  return await fetchJSONCORS(url);

  const res = await fetch(maybeProxy(url), { headers: { "Accept": "application/json" } });
  if (!res.ok) throw new Error(`ESCO occupation get failed: ${res.status}`);
  return await res.json(); // HAL object with description, labels, links
}


async function getEssentialSkillsForOccupation(uri, limit = 50) {
    const url = `${ESCO_BASE}/resource/related?uri=${encodeURIComponent(uri)}&relation=hasEssentialSkill&language=en&full=false&limit=${limit}`;
  const data = await fetchJSONCORS(url);
  const rel = data?._embedded?.related || data?.related || [];
  return rel
    .map((r) => asText(r.title) || asText(r.preferredLabel) || asText(r.label) || asText(r._links?.self?.title))
    .filter(Boolean);


}


function toPersona(occ, essentialSkills){
  const occUri = occ.uri || occ._links?.self?.href || occ._links?.occupation?.href || '';
  const label  = asText(occ.preferredLabel) || asText(occ.title) || asText(occ.prefLabel) || asText(occ.label) || "Unknown role";
  const id     = slugify(occUri || label.toLowerCase().replace(/\s+/g,'-'));
  const summary= asText(occ.description) || "";

  const alt = extractStrings(occ.altLabels || []);
  const coreTasks = dedupe([
    ...alt.slice(0, MAX_TASKS),
    ...safeFirstSentences(summary, 2)
  ]).slice(0, MAX_TASKS);

  const skillsRaw = (essentialSkills || []).map(asText).filter(Boolean);
  const skills = dedupe(skillsRaw).slice(0, MAX_SKILLS);

  const tone = defaultToneForOccupation(label);
  const goals = deriveGoalsFromSkills(skills);
  const pains = derivePainsFromSkills(skills);
  const vocab = skills.map(s => s.split(" ").slice(0,3).join(" "));

  return {
    id,
    name: label,
    profession: asText(occ.broaderPreferredLabel) || asText(occ.broaderPrefLabel) || label,
    seniority: "General",
    summary,
    goals,
    pain_points: pains,
    tone,
    vocabulary: vocab,
    tools: [],
    core_tasks: coreTasks,
    skills,
    tags: [],
    mappings: { esco_occupation: occUri, onetsoc: "" },
    sample_prompts: [
      `Draft a one-week plan to improve ${label.toLowerCase()} outcomes using the listed skills.`,
      `Given these pain points, propose three experiments to reduce risk.`
    ],
    dos: ["Cite evidence", "Show alternatives", "Prefer plain language"],
    donts: ["Speculate without data", "Overfit to one stakeholder"]
  };
}


function renderResults(list){
  el.results.innerHTML = '';
  el.count.textContent = list.length ? `(${list.length})` : '';
  list.slice(0, 50).forEach(item=>{
    const row = document.createElement('div');
    row.className = 'result';
    const left = document.createElement('div');
    left.innerHTML = `<div>${asText(item.title) || asText(item.preferredLabel) || 'Unknown'}</div><small>${asText(item.broaderPreferredLabel) || 'Occupation'}</small>`;
    const btn = document.createElement('button');
    btn.className = 'pick';
    btn.textContent = 'Add';
btn.addEventListener('click', async ()=>{
  btn.disabled = true;
  try {
    // Try full enrichment
    const full = await getOccupationByUri(item.uri);
    const skills = await getEssentialSkillsForOccupation(item.uri);
    const persona = toPersona(full, skills);
    selectedPersonas.push(persona);
  } catch (e) {
    console.warn('Enrichment failed, using minimal persona', e);
    // Minimal fallback from the suggestion row so the flow still works
    const name = asText(item.preferredLabel) || asText(item.title) || 'Unknown role';
    const id = slugify(item.uri || name.toLowerCase().replace(/\s+/g,'-'));
    selectedPersonas.push({
      id,
      name,
      profession: asText(item.broaderPreferredLabel) || name,
      seniority: "General",
      summary: "",
      goals: [],
      pain_points: [],
      tone: "Professional, clear, evidence-oriented",
      vocabulary: [],
      tools: [],
      core_tasks: [],
      skills: [],
      tags: [],
      mappings: { esco_occupation: item.uri || "", onetsoc: "" },
      sample_prompts: [],
      dos: ["Cite evidence", "Show alternatives", "Prefer plain language"],
      donts: ["Speculate without data", "Overfit to one stakeholder"]
    });
  } finally {
    updatePreview(); // updates Export enabled state too
    btn.disabled = false;
  }
});

}

function updatePreview(){
  el.selCount.textContent = selectedPersonas.length ? `(${selectedPersonas.length} selected)` : '';
  el.out.textContent = JSON.stringify({ version:1, personas: selectedPersonas }, null, 2);
  el.exportBtn.disabled = selectedPersonas.length === 0;

}


async function doSearch(){
  const q = el.q.value.trim();
  if (q.length < 2){ alert('Type at least 2 characters'); return; }
  el.results.innerHTML = '<div class="muted">Searching…</div>';
  try{
    let items = [];
    try {
      items = await searchOccupations(q); // primary (suggest2)
    } catch(e1) {
      console.warn('suggest2 failed, falling back', e1);
      items = await searchOccupationsFallback(q); // reliable fallback
    }
    renderResults(items);
  }catch(e){
    showError(e);
  }
}

async function searchOccupationsFallback(query, limit = 25) {
  // ESCO resource search fallback (slower but steady)
  const url = `${ESCO_BASE}/resource/occupation?text=${encodeURIComponent(query)}&language=en&limit=${limit}`;
  const res = await fetch(maybeProxy(url), { headers: { "Accept": "application/json" } });
  if (!res.ok) throw new Error(`ESCO occupation search failed: ${res.status}`);
  const data = await res.json();
  const list = data?._embedded?.occupation || [];
  return list.map(o => {
    const uri = o.uri || o._links?.self?.href || "";
    const title = o.preferredLabel || o.title || "";
    const broader = o.broaderPreferredLabel || "";
    return uri && title ? { uri, preferredLabel: title, broaderPreferredLabel: broader } : null;
  }).filter(Boolean);
}

// ---- Robust JSON fetch with proxy fallback ----
async function fetchJSONCORS(url, opts = {}) {
  // First try direct
  try {
    const r = await fetch(url, Object.assign({ headers: { "Accept": "application/json" } }, opts));
    if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
    return await r.json();
  } catch (err) {
    // Then try known CORS-friendly proxies (dev-only)
    const attempts = [
      `https://cors.isomorphic-git.org/${url}`,
      `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
    ];
    for (const proxied of attempts) {
      try {
        const r2 = await fetch(proxied, { headers: { "Accept": "application/json" } });
        const text = await r2.text(); // some proxies return text/plain
        if (!r2.ok) throw new Error(`Proxy HTTP ${r2.status} ${r2.statusText}`);
        return JSON.parse(text);
      } catch (_) { /* try next */ }
    }
    throw new Error(`Fetch failed: ${url} :: ${err.message || err}`);
  }
}



function showError(err) {
  const msg = (err && (err.message || err.toString())) || "Unknown error";
  console.error('ESCO error', err);
  el.results.innerHTML = `<div style="color:#b42318">Error: ${escapeHtml(msg)}</div>
  <div style="font-size:12px;color:#6b7280">Open DevTools → Network to see the failing request and status.<br/>If you see CORS errors, run a local server or toggle the dev proxy above.</div>`;
}
function escapeHtml(s){ return s.replace(/[&<>"'`=\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c])); }


function downloadJS(){
  const payload = {
    version: 1,
    source: 'ESCO',
    generated: new Date().toISOString(),
    personas: selectedPersonas
  };
  const js = `// personas.data.js — generated via test-persona.html
// Source: ESCO (https://ec.europa.eu/esco/)
// Generated: ${payload.generated}
window.PERSONAS = ${JSON.stringify(payload, null, 2)};`;
  try {
    const blob = new Blob([js], { type: 'application/javascript;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'personas.data.js';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  } catch (e) {
    console.error('Export failed:', e);
    alert('Export failed — check console for details.');
  }


// Wire up
el.search.addEventListener('click', doSearch);
el.q.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') doSearch(); });
el.exportBtn.addEventListener('click', downloadJS);

// Helpful default
el.q.value = 'ux';
doSearch();
</script>
</body>
</html>
